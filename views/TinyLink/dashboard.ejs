<% layout("/layouts/boilerplate") -%>
<style>
  @keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(.92);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.animate-fadeIn {
  animation: fadeIn 0.2s ease-out;
}

</style>


<div class="min-h-screen bg-gradient-to-br from-green-100 via-white to-green-50 p-6">
  
<!-- Bottom Stats Section -->
  <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mt-10">
    <h2 class="text-xl font-semibold mb-2">üîç Quick Summary</h2>
    <p class="text-gray-700 text-sm">
      Total Links: <b><%= links.length %></b>
      &nbsp; | &nbsp;
      Total Clicks: <b><%= links.reduce((total, l) => total + l.clicks, 0) %></b>
    </p>
  </div>

  <!-- Dashboard Container -->
  <div class="max-w-5xl mx-auto mt-12 bg-white/30 backdrop-blur-xl p-8 rounded-2xl shadow-lg border">

    <!-- Title & Health Check -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-3">
      <h1 class="text-2xl font-bold text-green-800">üìå Your Shortened Links</h1>
      
    </div>


    <!-- Search -->
    <div class="mb-4">
      <input id="searchInput" type="text" placeholder="Search by code or URL..."
        class="border p-3 rounded-md w-full" onkeyup="searchTable()" />
    </div>

    <!-- Links Table -->
    <div class="overflow-auto rounded-lg border shadow">
      <table class="w-full text-sm">
        <thead class="bg-green-600 text-white">
          <tr>
            <th class="p-3 text-left">Code</th>
            <th class="p-3 text-left">Target URL</th>
            <th class="p-3 text-center">Clicks</th>
            <th class="p-3 text-center">Last Clicked</th>
            <th class="p-3 text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="linksTable">
          <% links.forEach(link => { %>
            <tr class="border-b hover:bg-gray-50 transition">
              <!-- Short Code -->
              <td class="p-4 font-semibold text-blue-600">
  <a href="<%= baseURL %>/stats/<%= link.shortId %>" target="_blank" class="hover:underline">
    <%= link.shortId %>
  </a>
</td>

              <!-- Long URL -->
              <td class="p-4 max-w-md truncate">
                <a href="<%= link.fullURL %>" class="text-gray-700 hover:underline" target="_blank">
                  <%= link.fullURL %>
                </a>
              </td>

              <!-- Click Count -->
              <td class="p-4 text-center font-medium">
                <%= link.clicks %>
              </td>

              <!-- Created At -->
              <td class="p-4 text-center">
                <%= link.createdAt ? link.createdAt.toLocaleString() : "‚Äî" %>
              </td>

               <!-- Actions -->
              <td class="p-4 flex gap-2 justify-center text-sm">

                <!-- Stats Page -->
                <a href="/stats/<%= link.shortId %>" target="_blank"
                  class="bg-gray-200 px-3 py-1 rounded-md hover:bg-gray-300 transition">
                  Stats
                </a>

                <!-- Copy -->
              <script>
  function showToast(msg) {
    const toast = document.createElement("div");
    toast.innerText = msg;
    toast.className = "fixed bottom-6 right-6 bg-black text-white px-4 py-2 rounded shadow animate-fade";
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
  }
</script>

<button onclick="navigator.clipboard.writeText('<%= baseURL %>/stats/<%= link.shortId %>'); showToast('Copied!')"
class="bg-blue-200 px-3 py-1 rounded-md hover:bg-blue-300 transition">
  Copy
</button>

<style>
@keyframes fade {
  0% { opacity: 0; transform: translateY(10px); }
  10% { opacity: 1; transform: translateY(0); }
  90% { opacity: 1; }
  100% { opacity: 0; transform: translateY(10px); }
}
.animate-fade { animation: fade 2s forwards; }
</style>

            <!-- Edit -->
            <button
              onclick="openEditModal('<%= link._id %>', '<%= link.fullURL %>', '<%= link.shortId %>')"
              class="bg-yellow-200 px-3 py-1 rounded-md hover:bg-yellow-300 transition">
                Edit
            </button>








            
            <!-- Delete -->
              <form action="/stats/<%= link._id %>?_method=DELETE" method="POST"
                  onsubmit="return confirm('Are you sure you want to permanently delete this link?')">
                <button
                  class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition">
                   Delete
                </button>
              </form>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

  </div>
</div>

<script>
  function searchTable() {
    let input = document.getElementById("searchInput").value.toLowerCase();
    let rows = document.querySelectorAll("#linksTable tr");

    rows.forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
    });
  }
</script>


<!-- Edit Popup -->
<div id="editModal"
  class="fixed inset-0 hidden items-center justify-center backdrop-blur-md bg-[#1e293b]/50 z-50">

  <div class="bg-white mt-40 p-6 rounded-2xl w-96 relative shadow-2xl animate-fadeIn scale-100 items-center justify-center">
    
    <button onclick="closeEditModal()" 
      class="absolute right-3 top-2 text-xl font-bold text-gray-600 hover:text-red-500 transition">
      √ó
    </button>

    <h2 class="text-2xl font-semibold mb-4 text-center text-gray-800">Edit Link</h2>

    <form id="editForm" method="POST">
      <label class="text-sm font-medium">Full URL</label>
      <input type="text" name="fullURL" id="editFullURL"
        class="border p-2 rounded-md w-full mb-2 focus:ring-2 focus:ring-blue-500 outline-none"
        required>

      <label class="text-sm font-medium">Custom Short ID</label>
      <input type="text" name="customShortId" id="editShortId"
        class="border p-2 rounded-md w-full mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
        required>

      <button
        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg w-full font-medium transition">
        Save Changes
      </button>
    </form>
  </div>
</div>



<script>
  function openEditModal(id, fullURL, shortId) {
    const modal = document.getElementById("editModal");
    modal.classList.remove("hidden");
    
    document.getElementById("editFullURL").value = fullURL;
    document.getElementById("editShortId").value = shortId;
    document.getElementById("editForm").action = `/stats/${id}?_method=PUT`;
  }

  function closeEditModal() {
    document.getElementById("editModal").classList.add("hidden");
  }
</script>
