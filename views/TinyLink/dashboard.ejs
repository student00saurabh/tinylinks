<% layout("/layouts/boilerplate") -%>
<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: scale(.92); }
    to { opacity: 1; transform: scale(1); }
  }
  .animate-fadeIn { animation: fadeIn 0.2s ease-out; }

  @keyframes fade {
    0% { opacity: 0; transform: translateY(10px); }
    10% { opacity: 1; transform: translateY(0); }
    90% { opacity: 1; }
    100% { opacity: 0; transform: translateY(10px); }
  }
  .animate-fade { animation: fade 2s forwards; }
</style>

<div class="min-h-screen bg-gradient-to-br from-green-100 via-white to-green-50 p-6
            dark:from-gray-900 dark:via-gray-800 dark:to-gray-900">

  <!-- Bottom Stats Section -->
  <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mt-10
              dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
    <h2 class="text-xl font-semibold mb-2">üîç Quick Summary</h2>
    <p class="text-gray-700 text-sm dark:text-gray-300">
      Total Links: <b><%= links.length %></b>
      &nbsp; | &nbsp;
      Total Clicks: <b><%= links.reduce((total, l) => total + l.clicks, 0) %></b>
    </p>

    <div class="mb-4 mt-4 mx-w-50">
      <input id="searchInput" type="text" placeholder="Search by code or URL..."
        class="border p-3 rounded-md w-full dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 outline-none"
        onkeyup="searchLinks()" />
    </div>
  </div>

  <!-- Links List -->
  <div class="mt-12 space-y-4">

    <% links.forEach(link => { %>
    <div class="links-card bg-white dark:bg-gray-800 border dark:border-gray-600 dark:shadow-sm rounded-2xl shadow p-4 flex flex-col md:flex-row md:items-center md:justify-between animate-fadeIn">

      <!-- Code & URL -->
      <div class="flex flex-col md:flex-row md:items-center md:space-x-4 flex-1 mb-2 md:mb-0">
        <a href="<%= baseURL %>/stats/<%= link.shortId %>" target="_blank"
          class="font-semibold text-blue-600 dark:text-blue-400 hover:underline md:w-24">
          <%= link.shortId %>
        </a>

        <% if(link.encrypted){ %>
        <p class="text-gray-700 dark:text-gray-200 md:flex-1">
          <%= link.fullURL.length > 30 ? link.fullURL.slice(0, 30) + '...' : link.fullURL %>
        </p>
        <% } else { %>
        <a href="<%= link.fullURL %>" target="_blank"
          class="text-gray-700 dark:text-gray-200 hover:underline md:flex-1">
          <%= link.fullURL.length > 30 ? link.fullURL.slice(0, 30) + '...' : link.fullURL %>
        </a>
        <% } %>
      </div>

      <!-- Clicks & Date -->
      <div class="flex items-center space-x-4 text-sm text-gray-600 dark:text-gray-300 mb-2 md:mb-0">
        <span>Clicks: <b><%= link.clicks %></b></span>
        <span>Last: <%= link.createdAt ? link.createdAt.toLocaleString() : "‚Äî" %></span>
      </div>

      <!-- ACTION BUTTONS -->
      <div class="flex flex-wrap gap-2 justify-start md:justify-end p-2">

        <a href="/stats/<%= link.shortId %>" target="_blank"
          class="bg-gray-200 px-3 py-1 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 transition text-sm">
          Stats
        </a>

        <button onclick="navigator.clipboard.writeText('<%= baseURL %>/stats/<%= link.shortId %>'); showToast('Copied!')"
          class="bg-blue-200 px-3 py-1 rounded-md hover:bg-blue-300 dark:bg-blue-700 dark:hover:bg-blue-600 dark:text-white transition text-sm">
          Copy
        </button>

        <button onclick="openEditModal('<%= link._id %>', '<%= link.fullURL %>', '<%= link.shortId %>', '<%= link.private %>')"
          class="bg-yellow-200 px-3 py-1 rounded-md hover:bg-yellow-300 dark:bg-yellow-600 dark:hover:bg-yellow-500 dark:text-gray-900 transition text-sm">
          Edit
        </button>

        <form action="/stats/<%= link._id %>?_method=DELETE" method="POST"
          onsubmit="return confirm('Are you sure you want to permanently delete this link?')">
          <button class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 dark:bg-red-700 dark:hover:bg-red-600 transition text-sm">
            Delete
          </button>
        </form>

        <!-- NEW HISTORY BUTTON -->
        <button
  onclick="openHistoryModal(JSON.parse(decodeURIComponent('<%- encodeURIComponent(JSON.stringify(link.clickHistory || [])) %>')), '<%= link.shortId %>')"
  class="bg-purple-500 text-white px-3 py-1 rounded-md hover:bg-purple-600 transition text-sm">
  History
</button>

        <!-- Public/Private Badge -->
        <button class="<%= link.private ? 'bg-red-500 text-white' : 'bg-green-500 text-white' %> px-3 py-1 rounded-md text-sm cursor-default">
          <%= link.private ? 'Private' : 'Public' %>
        </button>

      </div>
    </div>
    <% }) %>

  </div>
</div>

<script>
  function searchLinks() {
    const input = document.getElementById("searchInput").value.toLowerCase();
    const cards = document.querySelectorAll(".links-card");
    cards.forEach(card => {
      const text = card.innerText.toLowerCase();
      card.style.display = text.includes(input) ? "flex" : "none";
    });
  }

  function showToast(msg) {
    const toast = document.createElement("div");
    toast.innerText = msg;
    toast.className = "fixed bottom-6 right-6 bg-black text-white px-4 py-2 rounded shadow animate-fade dark:bg-gray-700 dark:text-gray-200";
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
  }

  function openEditModal(id, fullURL, shortId, isPrivate) {
    const modal = document.getElementById("editModal");
    modal.classList.remove("hidden");

    document.getElementById("editFullURL").value = fullURL;
    document.getElementById("editShortId").value = shortId;
    document.getElementById("editIsPublic").checked = Boolean(!isPrivate);
    document.getElementById("editForm").action = `/stats/${id}?_method=PUT`;
  }

  function closeEditModal() {
    document.getElementById("editModal").classList.add("hidden");
  }

  /* -------------------------
     HISTORY MODAL
  -------------------------- */
  function openHistoryModal(history, code) {
    const modal = document.getElementById("historyModal");
    const list = document.getElementById("historyList");

    document.getElementById("historyTitle").innerText = `History ‚Äì ${code}`;
    list.innerHTML = "";

    if (history.length === 0) {
      list.innerHTML = `<p class='text-center text-gray-500 dark:text-gray-300'>No clicks yet.</p>`;
    } else {
      history.reverse().forEach(h => {
        const row = document.createElement("div");
        row.className = "border-b border-gray-300 dark:border-gray-600 py-3";
        row.innerHTML = `
          <p><b>IP:</b> ${h.ip || "N/A"}</p>
          <p><b>Country:</b> ${h.country || "N/A"}</p>
          <p><b>Browser:</b> ${h.browser || "N/A"}</p>
          <p><b>OS:</b> ${h.os || "N/A"}</p>
          <p><b>Platform:</b> ${h.platform || "N/A"}</p>
          <p><b>Time:</b> ${new Date(h.timestamp).toLocaleString()}</p>
        `;
        list.appendChild(row);
      });
    }

    modal.classList.remove("hidden");
  }

  function closeHistoryModal() {
    document.getElementById("historyModal").classList.add("hidden");
  }
</script>

<!-- EDIT MODAL -->
<div id="editModal" 
     class="fixed inset-0 hidden z-[9999] flex items-start justify-center bg-black/30 backdrop-blur-sm">
  <div class="!top-1/2 !-translate-y-1/2 bg-white dark:bg-gray-800 p-6 rounded-2xl w-96 shadow-2xl animate-fadeIn
              flex flex-col items-center justify-center relative m-2">

    <button onclick="closeEditModal()"
      class="absolute right-3 top-2 text-xl font-bold text-gray-600 dark:text-gray-300 hover:text-red-500 transition">√ó</button>

    <h2 class="text-2xl font-semibold mb-4 text-center text-gray-800 dark:text-gray-200">Edit Link</h2>

    <form id="editForm" method="POST" class="w-full">

      <label class="text-sm font-medium dark:text-gray-200">Full URL</label>
      <input type="text" name="fullURL" id="editFullURL"
        class="border p-2 rounded-md w-full mb-2 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
        required>

      <label class="text-sm font-medium dark:text-gray-200">Custom Short ID</label>
      <input type="text" name="customShortId" id="editShortId"
        class="border p-2 rounded-md w-full mb-4 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
        required>

      <div class="flex items-center gap-4 mb-4">
        <label class="flex items-center gap-2 text-gray-700 dark:text-gray-300">
          <input type="checkbox" name="private" id="editIsPublic"
            class="w-4 h-4 accent-blue-600 dark:accent-blue-500">
          Public URL
        </label>
      </div>

      <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg w-full font-medium transition">
        Save Changes
      </button>

    </form>
  </div>
</div>


<!-- NEW CLICK HISTORY MODAL -->
<div id="historyModal"
  class="fixed inset-0 hidden z-[9999] bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">

  <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl h-[80vh] overflow-y-auto shadow-xl p-6 relative animate-fadeIn">

    <button onclick="closeHistoryModal()"
      class="absolute right-4 top-3 text-2xl font-bold text-gray-600 dark:text-gray-300 hover:text-red-500">√ó</button>

    <h2 id="historyTitle" class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">
      History
    </h2>

    <div id="historyList" class="space-y-3 text-sm text-gray-700 dark:text-gray-300"></div>

  </div>
</div>
